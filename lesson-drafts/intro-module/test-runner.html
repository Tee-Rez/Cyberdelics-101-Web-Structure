<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intro Lesson Verification</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="../../core/styles.css">
    <link rel="stylesheet" href="../../methods/interactive-simulation/interactive-simulation.css">
    <link rel="stylesheet" href="../../methods/knowledge-construction/knowledge-construction.css">
    <link rel="stylesheet" href="../../methods/progressive-disclosure/progressive-disclosure.css">
    <link rel="stylesheet" href="../../methods/gamified-exploration/gamified-exploration.css">
    <link rel="stylesheet" href="../../methods/scenario-based/scenario-based.css">

    <!-- Simulation Styles -->
    <link rel="stylesheet"
        href="../../methods/interactive-simulation/constellation-personas/constellation-personas.css">

    <style>
        body {
            background-color: #050510;
            color: #fff;
            font-family: 'Inter', sans-serif;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        #lesson-root {
            min-height: 600px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #0a0a15;
            position: relative;
            overflow: hidden;
        }

        /* Mock specific styles for intro */
        .equation-builder {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            flex-wrap: wrap;
        }

        .setup-desk {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            background: #222;
            border-radius: 8px;
            justify-content: center;
        }

        .setup-desk .kc-slot {
            width: 100px;
            height: 100px;
            border: 2px dashed #555;
            display: flex;
            align-items: center;
            justify-content: center;
            content: attr(data-label);
        }

        /* Timeline fixes */
        .tz-artifact-point,
        .tz-artifact-icon,
        .tz-point-label,
        .tz-era-node {
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer !important;
        }

        /* Reposition info panel above timeline */
        .tz-shared-info-panel {
            bottom: auto !important;
            top: 10% !important;
        }

        /* Scenario continue button visibility */
        .scene-continue {
            display: none;
        }

        .scene-continue.visible {
            display: block;
        }
    </style>
</head>

<body>

    <h1>Intro Lesson Test Runner</h1>
    <div id="lesson-root"></div>
    <div id="debug-log" style="color: #aaa; margin-top: 1rem; font-family: monospace;"></div>

    <!-- Scripts: Loaded in dependency order -->
    <script src="../../core/method-base.js"></script>
    <script src="../../core/tutorial-overlay.js"></script>

    <!-- Method Factories -->
    <script src="../../methods/progressive-disclosure/progressive-disclosure.js"></script>
    <script src="../../methods/interactive-simulation/interactive-simulation.js"></script>
    <script src="../../methods/knowledge-construction/knowledge-construction.js"></script>
    <script src="../../methods/gamified-exploration/gamified-exploration.js"></script>
    <script src="../../methods/gamified-exploration/games/timeline-zoom.js"></script>
    <script src="../../methods/scenario-based/scenario-based.js"></script>

    <!-- Simulation Engines -->
    <script src="../../methods/interactive-simulation/constellation-personas/constellation-personas.js"></script>

    <!-- Core UI -->
    <script src="../../core/audio-player.js"></script>
    <script src="../../core/lesson-ui.js"></script>

    <!-- Core Runner (Loaded LAST to ensure factories exist) -->
    <script src="../../core/lesson-runner.js"></script>

    <script>
        function log(msg) {
            console.log(msg);
            document.getElementById('debug-log').innerHTML += `<div>${msg}</div>`;
        }

        try {
            // 1. Register Mock Engines
            window.SimulationEngines = window.SimulationEngines || {};
            log('Registering Mock Engines...');

            // Engine: Time Slider
            window.SimulationEngines['time-slider'] = {
                defaults: { year: 2025 },
                init: function (viewport, params) {
                    this.viewport = viewport;
                    this.display = document.createElement('div');
                    this.display.style.fontSize = '2rem';
                    this.display.style.textAlign = 'center';
                    this.display.style.marginTop = '20%';
                    viewport.appendChild(this.display);
                    this.update(0, params);
                },
                update: function (dt, params) {
                    const year = params.year;
                    let text = "";
                    if (year < 2020) text = "Visual: VR is clunky. Research starts.";
                    else if (year < 2030) text = "Visual: NOW. Convergence. Opportunity.";
                    else text = "Visual: Future. Established Field.";

                    this.display.innerHTML = `<h2>${year}</h2><p style='color:#00D9FF'>${text}</p>`;
                },
                destroy: function () { }
            };

            // Engine: Balance Scale
            window.SimulationEngines['balance-scale'] = {
                defaults: { ratio: 50 },
                init: function (viewport, params) {
                    this.viewport = viewport;
                    this.bar = document.createElement('div');
                    this.bar.style.width = '80%';
                    this.bar.style.height = '20px';
                    this.bar.style.background = '#333';
                    this.bar.style.margin = '100px auto';
                    this.bar.style.position = 'relative';

                    this.pivot = document.createElement('div');
                    this.pivot.style.width = '0';
                    this.pivot.style.height = '0';
                    this.pivot.style.borderLeft = '20px solid transparent';
                    this.pivot.style.borderRight = '20px solid transparent';
                    this.pivot.style.borderBottom = '40px solid #555';
                    this.pivot.style.position = 'absolute';
                    this.pivot.style.bottom = '-40px';
                    this.pivot.style.left = '50%';
                    this.pivot.style.transform = 'translateX(-50%)';

                    this.bar.appendChild(this.pivot);
                    viewport.appendChild(this.bar);
                    this.update(0, params);
                },
                update: function (dt, params) {
                    const rot = (params.ratio - 50) * 0.5; // -25 to 25 deg
                    this.bar.style.transform = `rotate(${rot}deg)`;
                },
                destroy: function () { }
            };

            // 3. Fetch and Run
            log('Initializing Runner...');
            const runner = window.LessonRunner;

            if (runner) {
                runner.init(document.getElementById('lesson-root'));

                log('Fetching manifest.json...');
                fetch('./manifest.json')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(manifest => {
                        log('Manifest loaded successfully.');
                        log('Loading Lesson...');
                        runner.loadLesson(manifest);
                    })
                    .catch(err => {
                        log('ERROR loading manifest: ' + err.message);
                        console.error(err);
                    });
            } else {
                log('ERROR: LessonRunner not found!');
            }

            // 4. Intro Tutorial Logic
            let tutorialHasRun = false;
            const observer = new MutationObserver((mutations) => {
                const intro2 = document.getElementById('intro-2-course-map');
                if (intro2 && !tutorialHasRun) {
                    tutorialHasRun = true;
                    setTimeout(runIntroTutorial, 1000); // Wait for UI to settle
                }
            });

            observer.observe(document.getElementById('lesson-root'), { childList: true, subtree: true });

            function runIntroTutorial() {
                log('Starting Intro Tutorial...');
                const container = document.body;
                const overlay = new TutorialOverlay(container);

                const steps = [
                    // Step 1: Open Left Sidebar
                    {
                        title: 'Interactive Mode',
                        text: 'We have hidden tools available. <strong>Open the Left Sidebar</strong> to reveal your inventory.',
                        target: '.cd-sidebar-left .cd-toggle-btn',
                        position: 'right',
                        spotlightSize: 60, // Small spotlight for button
                        showSkip: false,
                        showNext: false // Blocking: user must open sidebar
                    },
                    // Step 2: Inventory (Triggered after open)
                    {
                        title: 'Artifact Inventory',
                        text: 'Excellent. This is where your collected digital artifacts will be stored.',
                        target: '.cd-sidebar-left',
                        position: 'right',
                        spotlightShape: 'rect',
                        showSkip: false
                    },
                    // Step 3: Open Right Sidebar
                    {
                        title: 'Neural Interface',
                        text: 'Now, let\'s check your status. <strong>Open the Right Sidebar</strong>.',
                        target: '.cd-sidebar-right .cd-toggle-btn',
                        position: 'left',
                        spotlightSize: 60,
                        showSkip: false,
                        showNext: false // Blocking
                    },
                    // Step 4: Audio Player
                    {
                        title: 'Ambient Controls',
                        text: 'This panel contains the Binaural Audio Player. It is currently locked.',
                        target: '.cd-sidebar-right',
                        position: 'left',
                        spotlightShape: 'rect',
                        showSkip: false
                    },
                    // Step 5: Unlock Instructions
                    {
                        title: 'Mission Objective',
                        text: 'To unlock the audio tracks, you must collect <strong>5 Artifacts</strong> hidden within this map. Explore the timeline nodes to find them.',
                        target: '#intro-2-course-map',
                        position: 'center',
                        spotlightShape: 'rect',
                        showSkip: false,
                        showNext: true // User can finish
                    }
                ];

                // Start Tutorial
                overlay.start(steps);

                // --- Event Listeners for Blocking Steps ---

                // Watch for Left Sidebar Open (Step 1 -> 2)
                const leftSidebar = document.querySelector('.cd-sidebar-left');
                const checkLeftOpen = setInterval(() => {
                    // Check if NOT collapsed (meaning it's open)
                    // Note: Initially it has 'collapsed' class.
                    if (leftSidebar && !leftSidebar.classList.contains('collapsed') && overlay.currentStepIndex === 0) {
                        clearInterval(checkLeftOpen);
                        overlay.nextStep();
                    }
                }, 500);

                // Watch for Right Sidebar Open (Step 3 -> 4)
                const rightSidebar = document.querySelector('.cd-sidebar-right');
                const checkRightOpen = setInterval(() => {
                    if (rightSidebar && !rightSidebar.classList.contains('collapsed') && overlay.currentStepIndex === 2) {
                        clearInterval(checkRightOpen);
                        overlay.nextStep();
                    }
                }, 500);
            }

        } catch (e) {
            log('FATAL ERROR: ' + e.message);
            console.error(e);
        }
    </script>
</body>

</html>