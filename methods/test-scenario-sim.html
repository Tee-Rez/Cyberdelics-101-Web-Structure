<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario -> Sim Composition Test</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="../../core/styles.css">
    <link rel="stylesheet" href="interactive-simulation/interactive-simulation.css">
    <link rel="stylesheet" href="scenario-based/scenario-based.css">

    <style>
        body {
            background-color: #050510;
            color: #fff;
            font-family: 'Inter', sans-serif;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: #00D9FF;
        }

        .lesson-container {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            background: #0a0a15;
            min-height: 400px;
        }
    </style>
</head>

<body>

    <h1>Sequential Test: Scenario -> Simulation</h1>
    <p>Complete the scenario choices to unlock the simulation.</p>

    <!-- Container -->
    <div id="method-container" class="lesson-container"></div>

    <!-- Scripts -->
    <script src="../../core/method-base.js"></script>
    <script src="scenario-based/scenario-based.js"></script>
    <script src="interactive-simulation/interactive-simulation.js"></script>

    <script>
        // Mock Engine
        window.SimulationEngines = window.SimulationEngines || {};
        window.SimulationEngines['intensity-sim'] = {
            defaults: { intensity: 50 },
            config: [{ id: 'intensity', label: 'Intensity', min: 0, max: 100, step: 1 }],
            init: function (viewport, params) {
                this.div = document.createElement('div');
                this.div.style.padding = '2rem';
                this.div.style.fontSize = '1.5rem';
                this.div.textContent = `Simulation Loaded. Intensity: ${params.intensity}`;
                viewport.appendChild(this.div);
            },
            update: function (dt, params) {
                this.div.textContent = `Simulation Loaded. Intensity: ${params.intensity}`;
            },
            destroy: function () { }
        };

        const LessonController = {
            container: document.getElementById('method-container'),
            activeMethod: null,

            // Scenario Template
            scenarioTemplate: `
                <div class="scenario-container">
                    <div class="scenario-scene active" data-scene-id="intro">
                        <div class="scene-content">
                            <h2>The Experiment</h2>
                            <p class="scene-narrative">You are designing a simulation. How intense should it be?</p>
                            
                            <div class="scenario-choices">
                                <div class="choice-option" data-choice-id="low" data-outcome="outcome-low">
                                    <div class="choice-label">A</div>
                                    <div class="choice-text"><strong>Low Intensity</strong><p>Safe and calm.</p></div>
                                </div>
                                <div class="choice-option" data-choice-id="high" data-outcome="outcome-high">
                                    <div class="choice-label">B</div>
                                    <div class="choice-text"><strong>High Intensity</strong><p>Exciting and risky.</p></div>
                                </div>
                            </div>

                            <div class="scenario-outcome" data-outcome-id="outcome-low">
                                <div class="outcome-title">Outcome: Calm</div>
                                <p>You chose a gentle approach.</p>
                            </div>
                            <div class="scenario-outcome" data-outcome-id="outcome-high">
                                <div class="outcome-title">Outcome: Intense</div>
                                <p>You chose a radical approach.</p>
                            </div>

                            <div class="scene-nav">
                                <button class="scene-continue">Start Simulation</button>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            // Sim Template
            simTemplate: `
                <div class="interactive-simulation-container">
                    <div class="sim-viewport"></div>
                    <div class="sim-controls"></div>
                </div>
            `,

            init: function () {
                this.loadScenario();
            },

            loadScenario: function () {
                this.container.innerHTML = this.scenarioTemplate;

                // Init Scenario Method
                if (window.ScenarioBasedFactory) {
                    this.activeMethod = window.ScenarioBasedFactory();
                    this.activeMethod.init('.scenario-container');

                    // Listen for Completion or Scene Change
                    const handleTransition = () => this.transitionToSim();

                    this.activeMethod.on('sceneChanged', handleTransition);
                    this.activeMethod.on('scenarioComplete', handleTransition);
                } else {
                    console.error("ScenarioBasedFactory not found on window");
                }
            },

            transitionToSim: function () {
                // 1. Get State
                const history = this.activeMethod.getChoiceHistory();
                const choice = history[0].choiceId;
                const intensity = choice === 'high' ? 90 : 20;

                // 2. Destroy Old
                this.activeMethod.destroy();
                this.container.innerHTML = '';

                // 3. Load Sim
                this.container.innerHTML = this.simTemplate;
                this.activeMethod = window.InteractiveSimulationFactory();
                this.activeMethod.init('.interactive-simulation-container', {
                    engine: 'intensity-sim'
                });

                // Set Param
                // Hack: Access internal state or use an API if available?
                // Real way: 'init' accepts params? method-base init(container, options).
                // interactive-simulation.js: onInit(container, options). params = defaults.
                // It doesn't seemingly take override params in Init options currently.
                // Let's update internal state for verification
                if (this.activeMethod._state && this.activeMethod._state.engine) {
                    this.activeMethod._state.params.intensity = intensity;
                    // Trigger update?
                    this.activeMethod._updateControlUI();
                }
            }
        };

        // Delayed start to ensure scripts load (if async)
        setTimeout(() => LessonController.init(), 500);

    </script>
</body>

</html>