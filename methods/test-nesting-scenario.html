<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nested Scenario -> Sim Test</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="../../core/styles.css">
    <link rel="stylesheet" href="interactive-simulation/interactive-simulation.css">
    <link rel="stylesheet" href="scenario-based/scenario-based.css">

    <style>
        body {
            background-color: #050510;
            color: #fff;
            font-family: 'Inter', sans-serif;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: #00D9FF;
        }

        .scenario-container {
            margin-top: 2rem;
        }

        /* Constraint the embedded sim dimensions */
        .embedded-sim-wrapper {
            height: 300px;
            border: 1px solid #444;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
            display: none;
            /* Hidden until initialized/needed */
        }

        .embedded-sim-wrapper.active {
            display: block;
        }
    </style>
</head>

<body>

    <h1>Nested Test: Simulation inside Scenario</h1>
    <p>Advance the scenario to finding the "Simulation Terminal".</p>

    <!-- Scenario Container -->
    <div class="scenario-container">

        <!-- Scene 1: Exploration -->
        <div class="scenario-scene active" data-scene-id="scene1">
            <div class="scene-content">
                <h2>The Lab Entrance</h2>
                <p class="scene-narrative">You stand before the <strong>Cyberdelic Lab</strong>. A strange terminal hums
                    in the corner.</p>

                <div class="scenario-choices">
                    <div class="choice-option" data-choice-id="inspect">
                        <div class="choice-label">A</div>
                        <div class="choice-text"><strong>Inspect Terminal</strong>
                            <p>Look closer at the screen.</p>
                        </div>
                    </div>
                </div>

                <!-- Next scene trigger (usually handled by js nextScene logic via button, but we'll use auto-transition on choice for this test style or just a button) -->
                <!-- scenario-based.js requires a choice then usually a 'continue' button appears. -->
                <div class="scene-nav">
                    <button class="scene-continue">Approach Terminal</button>
                </div>
            </div>
        </div>

        <!-- Scene 2: The Simulation (Embedded) -->
        <div class="scenario-scene" data-scene-id="scene2">
            <div class="scene-content">
                <h2>The Terminal</h2>
                <p class="scene-narrative">The screen flickers to life. You can interact with the system directly.</p>

                <!-- Embedded Simulation Container -->
                <div class="embedded-sim-wrapper" id="sim-target">
                    <div class="interactive-simulation-container"
                        style="flex-direction: column; padding: 0.5rem; gap: 0.5rem;">
                        <div class="sim-viewport" style="min-height: 200px;"></div>
                        <div class="sim-controls" style="min-width: unset; padding: 0.5rem;"></div>
                    </div>
                </div>

                <div class="scene-nav">
                    <button class="scene-continue">Leave Terminal</button>
                </div>
            </div>
        </div>

        <!-- Scene 3: Outcome -->
        <div class="scenario-scene" data-scene-id="scene3">
            <div class="scene-content">
                <h2>Simulation Complete</h2>
                <p class="scene-narrative">You stepped away from the terminal, mind expanded.</p>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="../../core/method-base.js"></script>
    <script src="scenario-based/scenario-based.js"></script>
    <script src="interactive-simulation/interactive-simulation.js"></script>

    <script>
        // Mock Engine
        window.SimulationEngines = window.SimulationEngines || {};
        window.SimulationEngines['mini-sim'] = {
            defaults: { freq: 10 },
            config: [{ id: 'freq', label: 'Frequency', min: 0, max: 100, step: 10 }],
            init: function (viewport, params) {
                this.viewport = viewport;
                this.div = document.createElement('div');
                this.div.style.width = '100%';
                this.div.style.height = '100%';
                this.div.style.background = '#222';
                this.div.style.display = 'flex';
                this.div.style.alignItems = 'center';
                this.div.style.justifyContent = 'center';
                this.update(0, params);
                viewport.appendChild(this.div);
            },
            update: function (dt, params) {
                if (this.div) {
                    this.div.textContent = `~ WAVE ${params.freq} Hz ~`;
                    this.div.style.color = `hsl(${params.freq * 3}, 100%, 50%)`;
                }
            },
            destroy: function () { }
        };

        // Init Scenario
        const scenario = window.ScenarioBasedFactory();
        scenario.init('.scenario-container');

        // Listen for Scene Change to Scene 2
        scenario.on('sceneChanged', (data) => {
            if (data.scene.dataset.sceneId === 'scene2') {
                console.log("Entering Sim Scene. Initializing Embedded Sim...");

                const simWrapper = document.getElementById('sim-target');
                simWrapper.classList.add('active'); // Show it

                // Init Sim inside the wrapper
                const sim = window.InteractiveSimulationFactory();
                sim.init(simWrapper.querySelector('.interactive-simulation-container'), {
                    engine: 'mini-sim'
                });
            }
        });

    </script>
</body>

</html>