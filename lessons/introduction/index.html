<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberdelics 101: Introduction</title>

    <!-- Core Styles -->
    <link rel="stylesheet" href="../../core/styles.css">

    <!-- Method Styles -->
    <link rel="stylesheet" href="../../methods/progressive-disclosure/progressive-disclosure.css">
    <link rel="stylesheet" href="../../methods/scenario-based/scenario-based.css">
    <link rel="stylesheet" href="../../methods/interactive-simulation/interactive-simulation.css">
    <link rel="stylesheet" href="../../methods/interactive-simulation/engines/node-zoom.css">
    <link rel="stylesheet"
        href="../../methods/interactive-simulation/constellation-personas/constellation-personas.css">

    <style>
        body {
            background-color: var(--color-bg, #050505);
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* App-like feel */
            color: var(--color-text-primary, #e0e0e0);
            font-family: 'Rajdhani', sans-serif;
        }

        #lesson-root {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>

    <div id="lesson-root"></div>

    <!-- 1. Core Dependencies -->
    <script src="../../core/method-base.js"></script>
    <script src="../../core/method-loader.js"></script>
    <script src="../../core/lesson-ui.js"></script>
    <script src="../../core/artifact-system.js"></script>
    <script src="../../core/course-core.js"></script>
    <script src="../../core/state-manager.js"></script>
    <script src="../../core/audio-player.js"></script>
    <script src="../../core/tutorial-overlay.js"></script>

    <!-- 2. Method Factories -->
    <script src="../../methods/progressive-disclosure/progressive-disclosure.js?v=4"></script>
    <script src="../../methods/scenario-based/scenario-based.js?v=10"></script>
    <script src="../../methods/interactive-simulation/interactive-simulation.js"></script>
    <!-- Engines -->
    <script src="../../methods/interactive-simulation/engines/node-zoom.js"></script>
    <script src="../../methods/interactive-simulation/constellation-personas/constellation-personas.js"></script>

    <!-- 3. The Engine -->
    <script src="../../core/lesson-runner.js?v=9"></script>

    <!-- 4. The Manifest -->
    <script src="manifest.js?v=9"></script>

    <!-- 5. Boot Script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Runner attached to root
            LessonRunner.init('#lesson-root');

            try {
                // Check Global Manifest
                if (window.CourseManifest) {
                    LessonRunner.loadLesson(window.CourseManifest);
                } else {
                    throw new Error('CourseManifest not found. Ensure manifest.js is loaded.');
                }
            } catch (err) {
                console.error('Boot Error:', err);
                document.getElementById('lesson-root').innerHTML = `
                    <div style="padding: 2rem; color: #ff5555;">
                        <h2>System Error</h2>
                        <p>Could not initialize lesson sequence.</p>
                        <pre>${err.message}</pre>
                    </div>
                `;
            }

            // ---------------------------------------------------------
            // INTRO LESSON SPECIFIC TUTORIAL LOGIC
            // ---------------------------------------------------------
            let hasRunTutorial = false;

            const observer = new MutationObserver((mutations) => {
                const triggerZone = document.getElementById('intro-tutorial-root');

                if (triggerZone && !hasRunTutorial) {
                    const section = triggerZone.closest('.reveal-section');
                    // Only Run if the section is ACTIVE (Visible)
                    if (section && section.classList.contains('active')) {
                        hasRunTutorial = true;
                        console.log('[Intro] Tutorial Trigger Zone Active. Starting Sequence...');

                        // 1. Hide the "Explore Interface" button immediately
                        const nextBtn = section.querySelector('.reveal-trigger');
                        if (nextBtn) {
                            nextBtn.style.display = 'none';
                        }

                        // 2. Start Tutorial after short delay
                        setTimeout(() => {
                            runIntroTutorial(nextBtn);
                        }, 800);
                    }
                }
            });

            observer.observe(document.getElementById('lesson-root'), {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['class']
            });

            function runIntroTutorial(completionButton) {
                const overlay = new TutorialOverlay(document.body);

                overlay.onComplete = () => {
                    console.log('[Intro] Tutorial Complete. Unlocking button.');
                    if (completionButton) {
                        completionButton.style.display = 'inline-block';
                        completionButton.classList.add('pulse'); // Visual cue
                        completionButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };

                const steps = [
                    {
                        title: 'Interactive Mode',
                        text: 'We have hidden tools available. <strong>Open the Left Sidebar</strong> to reveal your inventory.',
                        target: '.cd-sidebar-left .cd-toggle-btn',
                        position: 'right',
                        spotlightSize: 60,
                        showSkip: false,
                        showNext: false // Blocking
                    },
                    {
                        title: 'Artifact Inventory',
                        text: 'Excellent. This is where your collected digital artifacts will be stored.',
                        target: '.cd-sidebar-left',
                        position: 'right',
                        spotlightShape: 'rect',
                        showSkip: false
                    },
                    {
                        title: 'Neural Interface',
                        text: 'Now, let\'s check your status. <strong>Open the Right Sidebar</strong>.',
                        target: '.cd-sidebar-right .cd-toggle-btn',
                        position: 'left',
                        spotlightSize: 60,
                        showSkip: false,
                        showNext: false // Blocking
                    },
                    {
                        title: 'Ambient Controls',
                        text: 'This panel contains the Binaural Audio Player. It is currently locked.',
                        target: '.cd-sidebar-right',
                        position: 'left',
                        spotlightShape: 'rect',
                        showSkip: false
                    },
                    {
                        title: 'Mission Objective',
                        text: 'To unlock the audio tracks, you must collect all the <strong> Artifacts</strong> hidden within the lesson.',
                        target: '.cyberdeck-main', // Updated target
                        position: 'center',
                        spotlightShape: 'rect',
                        showSkip: false,
                        showNext: true
                    }
                ];

                overlay.start(steps);

                // Event Listeners for Blocking Steps
                // Watch for Left Sidebar Open
                const leftSidebar = document.querySelector('.cd-sidebar-left');
                const checkLeftOpen = setInterval(() => {
                    if (leftSidebar && !leftSidebar.classList.contains('collapsed') && overlay.currentStepIndex === 0) {
                        clearInterval(checkLeftOpen);
                        overlay.nextStep();
                    }
                }, 500);

                // Watch for Right Sidebar Open
                const rightSidebar = document.querySelector('.cd-sidebar-right');
                const checkRightOpen = setInterval(() => {
                    if (rightSidebar && !rightSidebar.classList.contains('collapsed') && overlay.currentStepIndex === 2) {
                        clearInterval(checkRightOpen);
                        overlay.nextStep();
                    }
                }, 500);
            }

            // DEV: Add State Manager Toolbar
            const devBar = document.createElement('div');
            devBar.style.cssText = `
                position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
                background: rgba(0,0,0,0.8); border: 1px solid #333; padding: 5px 10px;
                border-radius: 20px; z-index: 9999; display: flex; gap: 10px;
                font-family: monospace; font-size: 12px; pointer-events: auto;
            `;
            devBar.innerHTML = `
                <span style="color: #666; align-self: center;">DEV:</span>
                <button id="dev-save">SAVE</button>
                <button id="dev-load">LOAD</button>
                <button id="dev-reset">RESET</button>
            `;
            document.body.appendChild(devBar);

            document.getElementById('dev-save').addEventListener('click', () => {
                StateManager.save();
                alert('State Saved!');
            });
            document.getElementById('dev-load').addEventListener('click', () => {
                const saved = localStorage.getItem('cd101_save_state');
                if (saved) {
                    StateManager.restore(JSON.parse(saved));
                    alert('State Restored!');
                } else {
                    alert('No save found.');
                }
            });
            document.getElementById('dev-reset').addEventListener('click', () => {
                localStorage.removeItem('cd101_save_state');
                location.reload();
            });

        });
    </script>

</body>

</html>